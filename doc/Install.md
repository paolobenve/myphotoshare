# Installation

## Dependencies

MyPhotoShare needs:

* `python3` (running it with Python 2 is possible, replace `python3` by `python2` in the first line in `scanner/main.py` and install the corresponding Python 2 dependencies).
* `python3-numpy`
* `python3-requests`
* `python3-pil`
* `avconv` / `ffmpeg` in order to be able to manage videos.
* a working web server (e.g. `apache`, `nginx`, etc.) with `php` module installed.
* `php5-gd` in order to create albums share images.
* `curl`, used by minify script.
* `cssmin` (`https://github.com/zacharyvoase/cssmin`, debian/ubuntu packages `cssmin`) and `jsmin` (`https://github.com/tikitu/jsmin`, debian/ubuntu package `python-jsmin`), unless using external web service


### Optional
* `python-opencv` if found, face detection is used when cropping images to square.
* OpenCV libraries and data (`opencv-data`)


### Why PHP? Isn't it enough with JavaScript?

PHP is *required* for sharing, because social apps do not execute any JavaScript when they receive an *URI*. Without PHP, sharing any page is perfectly equivalent to sharing the simple `index.html`: no information of the particular page you want to share is retained.

PHP does the job you need for sharing: JavaScript creates proper URLs based on the page hash, and when a share button is pressed a parameter is passed to PHP and it sets the proper HTML page title and appends the proper `<link rel='video_src' href="`video_link`">` or `<link rel='image_src' href="`image_link`">` tag to the `<head>` tag. This way the social media apps get the data they need and show a preview of the media/album you are sharing.


## Setup

Check that all dependencies are satified.
Be sure you installed `avconv` / `ffmpeg` if you have videos.


### Download the source code from the git repository:

```bash
    $ git clone https://github.com/paolobenve/myphotoshare.git
    $ cd myphotoshare
```

### Copy and tweak the configuration file

```bash
    $ sudo mkdir /etc/myphotoshare
    $ sudo cp myphotoshare.conf.defaults /etc/myphotoshare/myproject.conf
    $ sudo vim /etc/myphotoshare/myproject.conf
```

In your config file (the name `myproject.conf` can be whatever you want) you must set the proper folders for `albums` (where your original photos and videos are; they won't be modified) and `cache` (all the stuff generated by the scanner from the `albums` and that MyPhotoShare requires in order to work).


### Build the web page
This simply minifies and concatenate all JavaScript and CSS source files.

```bash
    $ ./js-css-minify.sh /etc/myphotoshare/myproject.conf
```

By default, a local minifier is used (cssmin and jsmin are currently supported, more local tools can easily be added). https://javascript-minifier.com/ and https://cssminifier.com/ web services may be used, changing options in the config file, but they are subject to timeout errors which the script cannot detect.


### Configure your web server

Be sure you have a web server installed (`apache2`, `nginx`, ...), with `php` and `php5-gd` modules installed and set.

The simplest way to configure the web server is:
```bash
    # Set `myphotoshare/web` subdir as the root of your site.
    $ ... see your web server documentation ...

    $ ln -s /absolute/path/to/your/albums/root albums
    # Create cache directory and give it proper permissions:
    # cache must be writable by the scanner and readable by the web server.
    $ mkdir cache
    $ chmod a+rw cache
```

However, the "Debian's way" could be better:

* Clone MyPhotoShare repository in `/usr/share`, so that you end with a `/usr/share/myphotoshare` directory.
* Copy `myphotoshare.conf.defaults` to `/etc/myphotoshare` and properly configure it.
* In your web site root, create symbolink links to MyPhotoShare `web` folder files and directories: `css`, `favicon.ico`, `fonts`, `img`, `index.php`, `js`
* Create a `cache` directory and make sure the scanner has write access to that directory.


## Updates

When MyPhotoShare code is updated, update your `myphotoshare` directory.

Go to the folder you cloned the repository in and execute:
```bash
    $ git pull https://github.com/paolobenve/myphotoshare.git
    $ ./js-css-minify.sh
```

Obviously the scanner should be launched too.


## Run the scanner to generate the albums

When you're done, run the static generator (you need Python3 or Pythonâ‰¥2.7 and the Python Imaging Library; for video something like `libav-conv` is required too):

```bash
    $ /your/myphotoshare/installation/dir/scanner/main.py /etc/myphotoshare/myproject.conf
```

After it finishes, you will be all set. Simply have your web server serve pages out of your web directory. You may want to do the scanning step in a cronjob, if you don't use the deployment makefiles mentioned below.

Note: The `albums` web folder and the `cache` one could be anywhere in the file system or in web, the only requierement is that the web server has access to them.


### Automatic scan `cron` file example

You can automate the updating process, so that you don't need to worry of running the scanner, simply do whatever you want on your albums tree, and MyPhotoShare `cache` directory will be updated every night:

Edit the following content into the `/etc/cron.d/myphotoshare` file:
```bash
    # update myphotoshare cache
    58 1  * * * root    /your/myphotoshare/installation/dir/scanner/main.py /etc/myphotoshare/myproject.conf > /var/log/my-myphotoshare-project.log
```

Instead or running `myphotoshare` as `root`, you can use whatever user that have access to the directories you set up in your config file.


## Face detection with OpenCV

When creating square thumbnail, MyPhotoShare can use [OpenCV](https://opencv.org/) to locate faces on a photo and crop the thumbnail centering the face.

First check that MyPhotoShare dependencies on OpenCV are satisfied.

On Debian Jessie or Ubuntu 16.04, Python 3 binding for OpenCV is not yet available. You'll have to run MyPhotoShare with Python 2. To do that, change `python3` to `python2` in the first line of `scanner/main.py`.

When running the scanner with a verbose level of at least 3, the scanner will print if it can load OpenCV and use it.

Testing that Python loads OpenCV:
```bash
    $ python3 -m cv2
```

Python will require also the XML file `haarcascade_frontalface_alt.xml` for face detection. On Debian based system, this file is provided by package `opencv-data`. If this file is not found, a message will be printed when the verbose level is at least 3.

```bash
$ ./main.py /etc/myphotoshare/myphotoshare.conf 
   2612236 2018-01-28 11:01:42.562583   [importer]                                     opencv library available, using it!
       118 2018-01-28 11:01:42.562701   |--[looking for file...]                          haarcascade_frontalface_default.xml
  67881115 2018-01-28 11:02:50.443816   |  |--[face xml file not found]                      haarcascade_frontalface_default.xml
     38652 2018-01-28 11:02:50.482468   [Options]                                      asterisk denotes options changed by config file
     ...
```
